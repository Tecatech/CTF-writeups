funcptrs = {
0x40544C: 0x04031C0,
0x4053A8: 0x0403218,
0x4053B4: 0x0403280,
0x4053F0: 0x04032E8,
0x405448: 0x0403340,
0x4053FC: 0x04033A0,
0x405400: 0x0403410,
0x405410: 0x0403468,
0x4053F8: 0x04034C0,
0x405430: 0x0403518,
0x4053D0: 0x0403570,
0x405434: 0x04035C8,
0x40545C: 0x0403620,
0x405454: 0x0403678,
0x4053C0: 0x04036D0,
0x4053E4: 0x0403728,
0x4053C4: 0x0403780,
0x405440: 0x04037D8,
0x4053BC: 0x0403830,
0x4053AC: 0x0403888,
0x405408: 0x04038E0,
0x4053D8: 0x0403938,
0x4053B8: 0x0403990,
0x4053C8: 0x04039E8,
0x4053E0: 0x0403A40,
0x405418: 0x0403A98,
0x4053EC: 0x0403AF0,
0x405414: 0x0403B48,
0x405450: 0x0403BA0,
0x4053E8: 0x0403BF8,
0x4053D4: 0x0403C50,
0x40541C: 0x0403CA8,
0x40542C: 0x0403D00,
0x405444: 0x0403D58,
0x405458: 0x0403DB0,
0x405420: 0x0403E08,
0x4053B0: 0x0403E60,
0x4053DC: 0x0403EB8,
0x405464: 0x0403F10,
0x4053CC: 0x0403F68,
0x405424: 0x0403FC0,
0x40543C: 0x0404018,
0x405404: 0x0404070,
0x405428: 0x04040C8,
0x405460: 0x0404120,
0x40540C: 0x0404178,
0x4053F4: 0x04041D0,
0x405438: 0x0404228,
}
ptrfuncs = {v:k for k,v in funcptrs.items()}
#fuckers^^

fucks=[
(0x4031c0, 0x1fe5 , 0x18),
(0x403218, 0x203d , 0x18),
(0x403280, 0x20a5 , 0x18),
(0x4032e8, 0x2113 , 0x18),
(0x403340, 0x2165 , 0x18),
(0x4033a0, 0x21c5 , 0x18),
(0x403410, 0x223b , 0x18),
(0x403468, 0x2293 , 0x18),
(0x4034c0, 0x22e5 , 0x18),
(0x403518, 0x233d , 0x18),
(0x403570, 0x239b , 0x18),
(0x4035c8, 0x23ed , 0x18),
(0x403620, 0x244b , 0x18),
(0x403678, 0x249d , 0x18),
(0x4036d0, 0x24f5 , 0x18),
(0x403728, 0x254d , 0x18),
(0x403780, 0x25a5 , 0x18),
(0x4037d8, 0x25fd , 0x18),
(0x403830, 0x265b , 0x18),
(0x403888, 0x26b3 , 0x18),
(0x4038e0, 0x270b , 0x18),
(0x403938, 0x2763 , 0x18),
(0x403990, 0x27bb , 0x18),
(0x4039e8, 0x2813 , 0x18),
(0x403a40, 0x286b , 0x18),
(0x403a98, 0x28bd , 0x18),
(0x403af0, 0x2915 , 0x18),
(0x403b48, 0x296d , 0x18),
(0x403ba0, 0x29c5 , 0x18),
(0x403bf8, 0x2a23 , 0x18),
(0x403c50, 0x2a7b , 0x18),
(0x403ca8, 0x2ad3 , 0x18),
(0x403d00, 0x2b2b , 0x18),
(0x403d58, 0x2b7d , 0x18),
(0x403db0, 0x2bd5 , 0x18),
(0x403e08, 0x2c2d , 0x18),
(0x403e60, 0x2c8b , 0x18),
(0x403eb8, 0x2cdd , 0x18),
(0x403f10, 0x2d3b , 0x18),
(0x403f68, 0x2d8d , 0x18),
(0x403fc0, 0x2deb , 0x18),
(0x404018, 0x2e3d , 0x18),
(0x404070, 0x2e9b , 0x18),
(0x4040c8, 0x2ef3 , 0x18),
(0x404120, 0x2f45 , 0x18),
(0x404178, 0x2fa3 , 0x18),
(0x4041d0, 0x2ffb , 0x18),
(0x404228, 0x304d , 0x18),
]
# lopok how many fucks i give

lilShitter = {
  0x40544C: 196,
  0x4053A8: 22,
  0x4053B4: 142,
  0x4053F0: 119,
  0x405448: 5,
  0x4053FC: 185,
  0x405400: 13,
  0x405410: 107,
  0x4053F8: 36,
  0x405430: 85,
  0x4053D0: 18,
  0x405434: 53,
  0x40545C: 118,
  0x405454: 231,
  0x4053C0: 251,
  0x4053E4: 160,
  0x4053C4: 218,
  0x405440: 52,
  0x4053BC: 132,
  0x4053AC: 180,
  0x405408: 200,
  0x4053D8: 155,
  0x4053B8: 239,
  0x4053C8: 180,
  0x4053E0: 185,
  0x405418: 10,
  0x4053EC: 87,
  0x405414: 92,
  0x405450: 254,
  0x4053E8: 197,
  0x4053D4: 106,
  0x40541C: 115,
  0x40542C: 73,
  0x405444: 189,
  0x405458: 17,
  0x405420: 214,
  0x4053B0: 143,
  0x4053DC: 107,
  0x405464: 10,
  0x4053CC: 151,
  0x405424: 171,
  0x40543C: 78,
  0x405404: 237,
  0x405428: 254,
  0x405460: 151,
  0x40540C: 249,
  0x4053F4: 152,
  0x405438: 101,
}
ciphert=b"\x96\x50\xcf\x2c\xeb\x9b\xaa\xfb\x53\xab\x73\xdd\x6c\x9e\xdb\xbc\xee\xab\x23\xd6\x16\xfd\xf1\xf0\xb9\x75\xc3\x28\xa2\x74\x7d\xe3\x27\xd5\x95\x5c\xf5\x76\x75\xc9\x8c\xfb\x42\x0e\xbd\x51\xa2\x98"

from capstone import *
from keystone import *
md = Cs(CS_ARCH_X86, CS_MODE_64) # disasm
ks = Ks(KS_ARCH_X86, KS_MODE_32) # asm

wowies = {}

exe = open('meow_way.exe','rb').read()
# new_exe = list(exe)
for meth_ea,fo, size in fucks: #meth
    fuck = exe[fo:fo+size]
    fuck= fuck[15:-3]# skip first 3 instrs, only get the 2 shit that actualy change
    disasm = list(md.disasm_lite(fuck, 0))
    # reenchoded = b''
    instrs = []
    for addr,sz,mnem,operands in disasm:
        operands
        instr = mnem + ' ' + operands
        # enchoding, count = ks.asm(instr)
        # enchoding=bytes(enchoding)
        # reenchoded += enchoding
        instrs.append(instr)
    assert len(disasm) == 2
    is_add_or_sub = 'add cl' in instrs[0]
    xor_key = instrs[1].split('xor cl, ')[1]
    if xor_key.startswith('0x'):
        xor_key = int(xor_key,16)
    else:
        xor_key = int(xor_key)
    ptr = ptrfuncs[meth_ea]

    esi = lilShitter[ptr]
    print(hex(meth_ea),hex(ptr),hex(esi),is_add_or_sub,xor_key,instrs)
    wowies[ptr] = (is_add_or_sub,xor_key)

order=[
0x40544C,
0x4053A8,
0x4053B4,
0x4053F0,
0x405448,
0x4053FC,
0x405400,
0x405410,
0x4053F8,
0x405430,
0x4053D0,
0x405434,
0x40545C,
0x405454,
0x4053C0,
0x4053E4,
0x4053C4,
0x405440,
0x4053BC,
0x4053AC,
0x405408,
0x4053D8,
0x4053B8,
0x4053C8,
0x4053E0,
0x405418,
0x4053EC,
0x405414,
0x405450,
0x4053E8,
0x4053D4,
0x40541C,
0x40542C,
0x405444,
0x405458,
0x405420,
0x4053B0,
0x4053DC,
0x405464,
0x4053CC,
0x405424,
0x40543C,
0x405404,
0x405428,
0x405460,
0x40540C,
0x4053F4,
0x405438]
from z3 import *
good_inp=b''
for i,ptr in enumerate(order):
    unk = BitVec('flag_%d' % i, 8)
    cl = BitVecVal(lilShitter[ptr],8)
    is_add_or_sub, xor_key = wowies[ptr]
    if is_add_or_sub:
        cl += unk
    else:
        cl -= unk
    cl ^= xor_key
    s = Solver()
    s.add(ciphert[i]==cl)
    assert s.check()==sat
    m=s.model()
    inp = m[unk].as_long()
    good_inp += bytes([inp])
print(good_inp)
